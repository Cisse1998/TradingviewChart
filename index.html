<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Deriv Professional Chart</title>
    <style>
        :root {
            --background: #0a0b0e;
            --card: #111827;
            --foreground: #f8fafc;
            --primary: #3b82f6;
            --primary-foreground: #ffffff;
            --secondary: #1e293b;
            --border: #374151;
            --chart-bullish: #10b981;
            --chart-bearish: #ef4444;
            --muted-foreground: #9ca3af;
            --grid-color: rgba(255, 255, 255, 0.1);
        }

        .light-mode {
            --background: #f8fafc;
            --card: #ffffff;
            --foreground: #0f172a;
            --primary: #3b82f6;
            --primary-foreground: #ffffff;
            --secondary: #f1f5f9;
            --border: #e2e8f0;
            --chart-bullish: #10b981;
            --chart-bearish: #ef4444;
            --muted-foreground: #64748b;
            --grid-color: rgba(0, 0, 0, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        body {
            background: var(--background);
            color: var(--foreground);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
        }

        /* Header */
        .header {
            background: var(--card);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid var(--border);
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        h1 {
            font-size: 1.8rem;
            background: linear-gradient(90deg, #3b82f6, #8b5cf6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .status-bar {
            display: flex;
            gap: 15px;
        }

        .status {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: var(--secondary);
            border-radius: 20px;
            font-size: 14px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #10b981;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Chart Container */
        .chart-container {
            background: var(--card);
            border-radius: 12px;
            padding: 0;
            border: 1px solid var(--border);
            margin-bottom: 20px;
            overflow: hidden;
        }

        /* Chart Controls */
        .chart-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            border-bottom: 1px solid var(--border);
            background: var(--secondary);
        }

        .left-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .chart-type-btn {
            padding: 8px 16px;
            background: var(--background);
            border: 1px solid var(--border);
            color: var(--foreground);
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .chart-type-btn.active {
            background: var(--primary);
            color: var(--primary-foreground);
            border-color: var(--primary);
        }

        .separator {
            width: 1px;
            height: 20px;
            background: var(--border);
            margin: 0 10px;
        }

        .timeframe-controls {
            display: flex;
            gap: 4px;
        }

        .timeframe-btn {
            padding: 6px 12px;
            background: var(--background);
            border: 1px solid var(--border);
            color: var(--foreground);
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .timeframe-btn.active {
            background: var(--primary);
            color: var(--primary-foreground);
            border-color: var(--primary);
        }

        /* Right Controls */
        .right-controls {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .tick-indicator {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            font-weight: bold;
            background: rgba(59, 130, 246, 0.1);
            border: 2px solid #3b82f6;
            color: #3b82f6;
        }

        .tick-indicator.up {
            background: rgba(16, 185, 129, 0.1);
            border-color: #10b981;
            color: #10b981;
        }

        .tick-indicator.down {
            background: rgba(239, 68, 68, 0.1);
            border-color: #ef4444;
            color: #ef4444;
        }

        /* Price Display */
        .price-display {
            padding: 15px 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .symbol-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .symbol-name {
            font-size: 1.2rem;
            font-weight: 600;
        }

        .price-value {
            font-size: 1.8rem;
            font-weight: 700;
            font-family: 'Courier New', monospace;
        }

        .price-value.up {
            color: #10b981;
        }

        .price-value.down {
            color: #ef4444;
        }

        .price-change {
            font-size: 0.9rem;
            color: var(--muted-foreground);
        }

        /* Chart Canvas */
        .chart-canvas-container {
            height: 500px;
            position: relative;
            background: var(--background);
        }

        #priceChart {
            width: 100%;
            height: 100%;
            display: block;
        }

        /* Indicators Panel */
        .indicators-panel {
            padding: 15px 20px;
            border-top: 1px solid var(--border);
            background: var(--secondary);
        }

        .indicators-list {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .indicator-badge {
            padding: 6px 12px;
            background: var(--background);
            border: 1px solid var(--border);
            border-radius: 20px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .indicator-color {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        /* Loading */
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: var(--muted-foreground);
            font-size: 14px;
        }

        /* Theme Toggle */
        .theme-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
        }

        .theme-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--secondary);
            border: 1px solid var(--border);
            color: var(--foreground);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Legend */
        .legend {
            display: flex;
            gap: 15px;
            padding: 10px 20px;
            font-size: 12px;
            border-top: 1px solid var(--border);
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .legend-color {
            width: 12px;
            height: 2px;
        }

        .instructions {
            text-align: center;
            font-size: 12px;
            color: var(--muted-foreground);
            padding: 10px 20px;
            border-top: 1px solid var(--border);
        }
    </style>
</head>
<body>
    <!-- Theme Toggle -->
    <div class="theme-toggle">
        <button class="theme-btn" id="themeToggle">üåô</button>
    </div>

    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="header-top">
                <h1>Deriv Professional Chart</h1>
                <div class="status-bar">
                    <div class="status">
                        <span class="status-dot"></span>
                        <span id="connectionStatus">Connecting...</span>
                    </div>
                    <div class="status">
                        <span>Symbol: <span id="currentSymbol">1HZ10V</span></span>
                    </div>
                    <div class="status">
                        <span>Candles: <span id="candleCount">0</span></span>
                    </div>
                    <div class="status">
                        <span>Ticks: <span id="tickCount">0</span></span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Chart Container -->
        <div class="chart-container">
            <!-- Chart Controls -->
            <div class="chart-controls">
                <div class="left-controls">
                    <button class="chart-type-btn active" id="candleBtn">
                        <span>üìä</span> Candles
                    </button>
                    <button class="chart-type-btn" id="lineBtn">
                        <span>üìà</span> Line
                    </button>
                    <div class="separator"></div>
                    <div class="timeframe-controls">
                        <button class="timeframe-btn active" data-timeframe="60">1M</button>
                        <button class="timeframe-btn" data-timeframe="300">5M</button>
                        <button class="timeframe-btn" data-timeframe="900">15M</button>
                        <button class="timeframe-btn" data-timeframe="1800">30M</button>
                        <button class="timeframe-btn" data-timeframe="3600">1H</button>
                    </div>
                </div>
                <div class="right-controls">
                    <div class="tick-indicator" id="tickIndicator">-</div>
                    <div>
                        <div style="font-size: 12px; color: var(--muted-foreground);">Last Price</div>
                        <div style="font-size: 16px; font-weight: 600;" id="lastPrice">--.--</div>
                    </div>
                </div>
            </div>

            <!-- Price Display -->
            <div class="price-display">
                <div class="symbol-info">
                    <div class="symbol-name" id="symbolName">Volatility 10 (1s) Index</div>
                    <div class="price-value" id="currentPrice">--.--</div>
                    <div class="price-change" id="priceChange">+0.00 (0.00%)</div>
                </div>
            </div>

            <!-- Chart Canvas -->
            <div class="chart-canvas-container">
                <canvas id="priceChart"></canvas>
                <div class="loading" id="chartLoading">Loading chart data...</div>
            </div>

            <!-- Indicators Panel -->
            <div class="indicators-panel">
                <div class="indicators-list" id="indicatorsList">
                    <div class="indicator-badge">
                        <span class="indicator-color" style="background: #f59e0b;"></span>
                        SMA 20
                    </div>
                    <div class="indicator-badge">
                        <span class="indicator-color" style="background: #10b981;"></span>
                        EMA 20
                    </div>
                    <div class="indicator-badge">
                        <span class="indicator-color" style="background: #8b5cf6;"></span>
                        Bollinger Bands
                    </div>
                </div>
            </div>

            <!-- Legend -->
            <div class="legend" id="chartLegend">
                <div class="legend-item">
                    <div class="legend-color" style="background: #10b981;"></div>
                    <span>Bullish Candle</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #ef4444;"></div>
                    <span>Bearish Candle</span>
                </div>
            </div>

            <!-- Instructions -->
            <div class="instructions" id="instructions">
                Scroll to zoom ‚Ä¢ Drag to pan ‚Ä¢ Ctrl+Scroll for fine zoom
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const DERIV_WS_URL = 'wss://ws.binaryws.com/websockets/v3?app_id=1089';
        const MAX_CANDLES = 100;
        const MIN_VISIBLE_CANDLES = 50;
        const ZOOM_STEP = 0.2;

        // Supported symbols
        const SYMBOLS = {
            '1HZ10V': { name: 'Volatility 10 (1s) Index', type: '1s', basePrice: 35000 },
            'R_10': { name: 'Volatility 10 Index', type: 'standard', basePrice: 35000 },
            '1HZ15V': { name: 'Volatility 15 (1s) Index', type: '1s', basePrice: 35000 },
            '1HZ25V': { name: 'Volatility 25 (1s) Index', type: '1s', basePrice: 35000 },
            'R_25': { name: 'Volatility 25 Index', type: 'standard', basePrice: 35000 },
            '1HZ30V': { name: 'Volatility 30 (1s) Index', type: '1s', basePrice: 35000 },
            '1HZ50V': { name: 'Volatility 50 (1s) Index', type: '1s', basePrice: 35000 },
            'R_50': { name: 'Volatility 50 Index', type: 'standard', basePrice: 35000 },
            '1HZ75V': { name: 'Volatility 75 (1s) Index', type: '1s', basePrice: 35000 },
            'R_75': { name: 'Volatility 75 Index', type: 'standard', basePrice: 35000 },
            '1HZ90V': { name: 'Volatility 90 (1s) Index', type: '1s', basePrice: 35000 },
            '1HZ100V': { name: 'Volatility 100 (1s) Index', type: '1s', basePrice: 35000 },
            'R_100': { name: 'Volatility 100 Index', type: 'standard', basePrice: 35000 }
        };

        // Global state
        let socket = null;
        let activeSymbol = '1HZ10V';
        let activeTimeframe = 60;
        let chartType = 'candlestick';
        let candles = [];
        let currentCandle = null;
        let currentPrice = 0;
        let previousPrice = 0;
        let tickCount = 0;
        let zoomLevel = 1;
        let panOffset = 0;
        let ctx = null;
        let canvas = null;
        let isDragging = false;
        let dragStartX = 0;
        let dragStartOffset = 0;

        // Generate sample candles for testing
        function generateSampleCandles(count = 100) {
            const now = Date.now();
            const basePrice = SYMBOLS[activeSymbol]?.basePrice || 35000;
            const sampleCandles = [];
            
            for (let i = 0; i < count; i++) {
                const time = now - (count - i) * 60 * 1000; // 1 minute intervals
                const open = basePrice + Math.random() * 1000 - 500;
                const close = open + Math.random() * 2000 - 1000;
                const high = Math.max(open, close) + Math.random() * 500;
                const low = Math.min(open, close) - Math.random() * 500;
                
                sampleCandles.push({
                    time: time,
                    open: open,
                    high: high,
                    low: low,
                    close: close,
                    volume: Math.random() * 1000
                });
            }
            
            return sampleCandles;
        }

        // Theme management
        function initTheme() {
            const themeBtn = document.getElementById('themeToggle');
            const savedTheme = localStorage.getItem('theme') || 'dark';
            
            if (savedTheme === 'light') {
                document.body.classList.add('light-mode');
                themeBtn.textContent = 'üåô';
            } else {
                themeBtn.textContent = '‚òÄÔ∏è';
            }
            
            themeBtn.addEventListener('click', () => {
                if (document.body.classList.contains('light-mode')) {
                    document.body.classList.remove('light-mode');
                    localStorage.setItem('theme', 'dark');
                    themeBtn.textContent = '‚òÄÔ∏è';
                } else {
                    document.body.classList.add('light-mode');
                    localStorage.setItem('theme', 'light');
                    themeBtn.textContent = 'üåô';
                }
                drawChart();
            });
        }

        // Initialize chart
        function initChart() {
            canvas = document.getElementById('priceChart');
            ctx = canvas.getContext('2d');
            
            // Set canvas size
            canvas.width = canvas.offsetWidth;
            canvas.height = canvas.offsetHeight;
            
            // Event listeners
            canvas.addEventListener('wheel', handleWheel);
            canvas.addEventListener('mousedown', handleMouseDown);
            canvas.addEventListener('mousemove', handleMouseMove);
            canvas.addEventListener('mouseup', handleMouseUp);
            canvas.addEventListener('mouseleave', handleMouseUp);
            
            // Generate sample data for testing
            candles = generateSampleCandles();
            currentPrice = candles[candles.length - 1]?.close || 0;
            
            // Hide loading
            document.getElementById('chartLoading').style.display = 'none';
            
            // Initial draw
            drawChart();
        }

        // Handle zoom and pan
        function handleWheel(e) {
            e.preventDefault();
            
            if (e.ctrlKey || e.metaKey) {
                // Zoom
                if (e.deltaY < 0) {
                    zoomIn();
                } else {
                    zoomOut();
                }
            } else {
                // Pan
                const delta = e.deltaY > 0 ? 5 : -5;
                panOffset = Math.max(0, Math.min(
                    panOffset + delta,
                    Math.max(0, candles.length - getVisibleCandleCount())
                ));
            }
            
            drawChart();
        }

        function handleMouseDown(e) {
            isDragging = true;
            dragStartX = e.clientX;
            dragStartOffset = panOffset;
            canvas.style.cursor = 'grabbing';
        }

        function handleMouseMove(e) {
            if (!isDragging) return;
            
            const deltaX = e.clientX - dragStartX;
            const pixelToCandleRatio = getVisibleCandleCount() / canvas.width;
            panOffset = Math.max(0, Math.min(
                dragStartOffset - deltaX * pixelToCandleRatio,
                Math.max(0, candles.length - getVisibleCandleCount())
            ));
            
            drawChart();
        }

        function handleMouseUp() {
            isDragging = false;
            canvas.style.cursor = 'default';
        }

        function zoomIn() {
            zoomLevel = Math.min(zoomLevel + ZOOM_STEP, candles.length / MIN_VISIBLE_CANDLES);
        }

        function zoomOut() {
            zoomLevel = Math.max(zoomLevel - ZOOM_STEP, 1);
        }

        function getVisibleCandleCount() {
            return Math.max(MIN_VISIBLE_CANDLES, Math.floor(candles.length / zoomLevel));
        }

        // Chart drawing
        function drawChart() {
            if (!ctx || !canvas) return;
            
            // Clear canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            if (candles.length === 0) {
                drawNoData();
                return;
            }
            
            // Calculate visible range
            const visibleCount = getVisibleCandleCount();
            const startIndex = Math.max(0, Math.floor(panOffset));
            const endIndex = Math.min(startIndex + visibleCount, candles.length);
            const visibleCandles = candles.slice(startIndex, endIndex);
            
            if (visibleCandles.length === 0) {
                drawNoData();
                return;
            }
            
            // Calculate price range
            const priceRange = getPriceRange(visibleCandles);
            
            // Chart dimensions
            const padding = { left: 80, right: 40, top: 30, bottom: 40 };
            const chartWidth = canvas.width - padding.left - padding.right;
            const chartHeight = canvas.height - padding.top - padding.bottom;
            
            // Draw grid
            drawGrid(padding, chartWidth, chartHeight, priceRange);
            
            // Draw indicators
            drawIndicators(visibleCandles, padding, chartWidth, chartHeight, priceRange);
            
            // Draw candles or line
            if (chartType === 'candlestick') {
                drawCandlesticks(visibleCandles, padding, chartWidth, chartHeight, priceRange);
            } else {
                drawLineChart(visibleCandles, padding, chartWidth, chartHeight, priceRange);
            }
            
            // Draw current price line
            if (currentPrice > 0) {
                drawCurrentPriceLine(padding, chartWidth, chartHeight, priceRange);
            }
            
            // Draw axes
            drawAxes(padding, chartWidth, chartHeight, visibleCandles);
            
            // Update candle count
            document.getElementById('candleCount').textContent = candles.length;
        }

        function getPriceRange(candles) {
            let min = Infinity;
            let max = -Infinity;
            
            candles.forEach(candle => {
                min = Math.min(min, candle.low);
                max = Math.max(max, candle.high);
            });
            
            // Add SMA 20
            const sma20 = calculateSMA(candles, 20);
            sma20.forEach(val => {
                if (val !== null) {
                    min = Math.min(min, val);
                    max = Math.max(max, val);
                }
            });
            
            // Add EMA 20
            const ema20 = calculateEMA(candles, 20);
            ema20.forEach(val => {
                if (val !== null) {
                    min = Math.min(min, val);
                    max = Math.max(max, val);
                }
            });
            
            // Add Bollinger Bands
            const bb = calculateBollingerBands(candles, 20, 2);
            bb.upper.forEach((val, i) => {
                if (val !== null && bb.lower[i] !== null) {
                    min = Math.min(min, bb.lower[i]);
                    max = Math.max(max, val);
                }
            });
            
            // Add padding
            const padding = (max - min) * 0.05;
            return {
                min: min - padding,
                max: max + padding
            };
        }

        function drawGrid(padding, chartWidth, chartHeight, priceRange) {
            // Grid background
            ctx.fillStyle = document.body.classList.contains('light-mode') 
                ? '#ffffff' 
                : '#111827';
            ctx.fillRect(padding.left, padding.top, chartWidth, chartHeight);
            
            // Grid lines
            ctx.strokeStyle = document.body.classList.contains('light-mode') 
                ? 'rgba(0, 0, 0, 0.1)' 
                : 'rgba(255, 255, 255, 0.1)';
            ctx.lineWidth = 1;
            
            // Horizontal grid lines
            for (let i = 0; i <= 10; i++) {
                const y = padding.top + (i * chartHeight / 10);
                ctx.beginPath();
                ctx.moveTo(padding.left, y);
                ctx.lineTo(padding.left + chartWidth, y);
                ctx.stroke();
            }
            
            // Vertical grid lines
            for (let i = 0; i <= 10; i++) {
                const x = padding.left + (i * chartWidth / 10);
                ctx.beginPath();
                ctx.moveTo(x, padding.top);
                ctx.lineTo(x, padding.top + chartHeight);
                ctx.stroke();
            }
            
            // Price labels on Y-axis
            ctx.fillStyle = document.body.classList.contains('light-mode') ? '#666' : '#aaa';
            ctx.font = '12px -apple-system, BlinkMacSystemFont, sans-serif';
            ctx.textAlign = 'right';
            ctx.textBaseline = 'middle';
            
            for (let i = 0; i <= 10; i++) {
                const price = priceRange.max - (priceRange.max - priceRange.min) * i / 10;
                const y = padding.top + (i * chartHeight / 10);
                ctx.fillText(price.toFixed(2), padding.left - 10, y);
            }
        }

        function drawCandlesticks(candles, padding, chartWidth, chartHeight, priceRange) {
            const candleWidth = Math.max(2, Math.min(20, chartWidth / candles.length * 0.7));
            
            for (let i = 0; i < candles.length; i++) {
                const candle = candles[i];
                const isBullish = candle.close >= candle.open;
                const color = isBullish ? '#10b981' : '#ef4444';
                
                // Calculate positions
                const x = padding.left + (i * chartWidth / candles.length) + (chartWidth / candles.length / 2);
                
                // Convert prices to Y coordinates
                const openY = priceToY(candle.open, priceRange, padding, chartHeight);
                const closeY = priceToY(candle.close, priceRange, padding, chartHeight);
                const highY = priceToY(candle.high, priceRange, padding, chartHeight);
                const lowY = priceToY(candle.low, priceRange, padding, chartHeight);
                
                // Draw wick (vertical line from high to low)
                ctx.strokeStyle = color;
                ctx.lineWidth = 1;
                ctx.beginPath();
                ctx.moveTo(x, highY);
                ctx.lineTo(x, lowY);
                ctx.stroke();
                
                // Draw body (rectangle from open to close)
                ctx.fillStyle = color;
                const bodyTop = Math.min(openY, closeY);
                const bodyHeight = Math.max(Math.abs(closeY - openY), 1);
                ctx.fillRect(x - candleWidth / 2, bodyTop, candleWidth, bodyHeight);
                
                // Draw body border
                ctx.strokeStyle = color;
                ctx.lineWidth = 1;
                ctx.strokeRect(x - candleWidth / 2, bodyTop, candleWidth, bodyHeight);
            }
        }

        function drawLineChart(candles, padding, chartWidth, chartHeight, priceRange) {
            ctx.strokeStyle = '#3b82f6';
            ctx.lineWidth = 2;
            ctx.beginPath();
            
            for (let i = 0; i < candles.length; i++) {
                const x = padding.left + (i * chartWidth / candles.length) + (chartWidth / candles.length / 2);
                const y = priceToY(candles[i].close, priceRange, padding, chartHeight);
                
                if (i === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
            }
            ctx.stroke();
            
            // Draw dots at data points
            ctx.fillStyle = '#3b82f6';
            for (let i = 0; i < candles.length; i += Math.max(1, Math.floor(candles.length / 10))) {
                const x = padding.left + (i * chartWidth / candles.length) + (chartWidth / candles.length / 2);
                const y = priceToY(candles[i].close, priceRange, padding, chartHeight);
                ctx.beginPath();
                ctx.arc(x, y, 3, 0, Math.PI * 2);
                ctx.fill();
            }
        }

        function drawIndicators(candles, padding, chartWidth, chartHeight, priceRange) {
            // SMA 20
            const sma20 = calculateSMA(candles, 20);
            ctx.strokeStyle = '#f59e0b';
            ctx.lineWidth = 2;
            ctx.beginPath();
            
            for (let i = 0; i < candles.length; i++) {
                if (sma20[i] === null) continue;
                
                const x = padding.left + (i * chartWidth / candles.length) + (chartWidth / candles.length / 2);
                const y = priceToY(sma20[i], priceRange, padding, chartHeight);
                
                if (i === 0 || sma20[i-1] === null) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
            }
            ctx.stroke();
            
            // EMA 20
            const ema20 = calculateEMA(candles, 20);
            ctx.strokeStyle = '#10b981';
            ctx.lineWidth = 2;
            ctx.beginPath();
            
            for (let i = 0; i < candles.length; i++) {
                if (ema20[i] === null) continue;
                
                const x = padding.left + (i * chartWidth / candles.length) + (chartWidth / candles.length / 2);
                const y = priceToY(ema20[i], priceRange, padding, chartHeight);
                
                if (i === 0 || ema20[i-1] === null) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
            }
            ctx.stroke();
            
            // Bollinger Bands
            const bb = calculateBollingerBands(candles, 20, 2);
            
            // Fill between bands
            ctx.fillStyle = 'rgba(139, 92, 246, 0.15)';
            ctx.beginPath();
            
            for (let i = 0; i < candles.length; i++) {
                if (bb.upper[i] === null) continue;
                
                const x = padding.left + (i * chartWidth / candles.length) + (chartWidth / candles.length / 2);
                const y = priceToY(bb.upper[i], priceRange, padding, chartHeight);
                
                if (i === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
            }
            
            for (let i = candles.length - 1; i >= 0; i--) {
                if (bb.lower[i] === null) continue;
                
                const x = padding.left + (i * chartWidth / candles.length) + (chartWidth / candles.length / 2);
                const y = priceToY(bb.lower[i], priceRange, padding, chartHeight);
                ctx.lineTo(x, y);
            }
            
            ctx.closePath();
            ctx.fill();
            
            // Draw bands
            ctx.strokeStyle = '#8b5cf6';
            ctx.lineWidth = 1;
            ctx.setLineDash([4, 2]);
            
            // Upper band
            ctx.beginPath();
            for (let i = 0; i < candles.length; i++) {
                if (bb.upper[i] === null) continue;
                
                const x = padding.left + (i * chartWidth / candles.length) + (chartWidth / candles.length / 2);
                const y = priceToY(bb.upper[i], priceRange, padding, chartHeight);
                
                if (i === 0 || bb.upper[i-1] === null) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
            }
            ctx.stroke();
            
            // Middle band
            ctx.setLineDash([]);
            ctx.lineWidth = 1.5;
            ctx.beginPath();
            for (let i = 0; i < candles.length; i++) {
                if (bb.middle[i] === null) continue;
                
                const x = padding.left + (i * chartWidth / candles.length) + (chartWidth / candles.length / 2);
                const y = priceToY(bb.middle[i], priceRange, padding, chartHeight);
                
                if (i === 0 || bb.middle[i-1] === null) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
            }
            ctx.stroke();
            
            // Lower band
            ctx.setLineDash([4, 2]);
            ctx.lineWidth = 1;
            ctx.beginPath();
            for (let i = 0; i < candles.length; i++) {
                if (bb.lower[i] === null) continue;
                
                const x = padding.left + (i * chartWidth / candles.length) + (chartWidth / candles.length / 2);
                const y = priceToY(bb.lower[i], priceRange, padding, chartHeight);
                
                if (i === 0 || bb.lower[i-1] === null) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
            }
            ctx.stroke();
            
            ctx.setLineDash([]);
        }

        function drawCurrentPriceLine(padding, chartWidth, chartHeight, priceRange) {
            const y = priceToY(currentPrice, priceRange, padding, chartHeight);
            
            ctx.strokeStyle = currentPrice > previousPrice ? '#10b981' : '#ef4444';
            ctx.lineWidth = 1;
            ctx.setLineDash([3, 3]);
            
            ctx.beginPath();
            ctx.moveTo(padding.left, y);
            ctx.lineTo(padding.left + chartWidth, y);
            ctx.stroke();
            
            ctx.setLineDash([]);
            
            // Draw price label
            ctx.fillStyle = currentPrice > previousPrice ? '#10b981' : '#ef4444';
            ctx.font = 'bold 12px -apple-system, BlinkMacSystemFont, sans-serif';
            ctx.textAlign = 'right';
            ctx.textBaseline = 'middle';
            ctx.fillText(currentPrice.toFixed(2), padding.left + chartWidth + 10, y);
        }

        function drawAxes(padding, chartWidth, chartHeight, candles) {
            // Y-axis line
            ctx.strokeStyle = document.body.classList.contains('light-mode') ? '#000' : '#fff';
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(padding.left, padding.top);
            ctx.lineTo(padding.left, padding.top + chartHeight);
            ctx.stroke();
            
            // X-axis line
            ctx.beginPath();
            ctx.moveTo(padding.left, padding.top + chartHeight);
            ctx.lineTo(padding.left + chartWidth, padding.top + chartHeight);
            ctx.stroke();
            
            // Time labels on X-axis
            ctx.fillStyle = document.body.classList.contains('light-mode') ? '#666' : '#aaa';
            ctx.font = '12px -apple-system, BlinkMacSystemFont, sans-serif';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'top';
            
            const labelCount = Math.min(5, candles.length);
            for (let i = 0; i < labelCount; i++) {
                const index = Math.floor((i / (labelCount - 1)) * (candles.length - 1));
                const x = padding.left + (index * chartWidth / (candles.length - 1)) + (chartWidth / candles.length / 2);
                const time = new Date(candles[index].time);
                const timeStr = `${time.getHours().toString().padStart(2, '0')}:${time.getMinutes().toString().padStart(2, '0')}`;
                ctx.fillText(timeStr, x, padding.top + chartHeight + 10);
            }
        }

        function drawNoData() {
            ctx.fillStyle = document.body.classList.contains('light-mode') ? '#666' : '#999';
            ctx.font = '16px -apple-system, BlinkMacSystemFont, sans-serif';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText('Loading chart data...', canvas.width / 2, canvas.height / 2);
        }

        function priceToY(price, priceRange, padding, chartHeight) {
            return padding.top + chartHeight - 
                   ((price - priceRange.min) / (priceRange.max - priceRange.min)) * chartHeight;
        }

        // Indicator calculations
        function calculateSMA(candles, period) {
            if (candles.length < period) return new Array(candles.length).fill(null);
            
            const sma = new Array(candles.length).fill(null);
            for (let i = period - 1; i < candles.length; i++) {
                let sum = 0;
                for (let j = 0; j < period; j++) {
                    sum += candles[i - j].close;
                }
                sma[i] = sum / period;
            }
            return sma;
        }

        function calculateEMA(candles, period) {
            if (candles.length < period) return new Array(candles.length).fill(null);
            
            const multiplier = 2 / (period + 1);
            let ema = candles[0].close;
            const emaValues = new Array(candles.length).fill(null);
            emaValues[0] = ema;
            
            for (let i = 1; i < candles.length; i++) {
                ema = (candles[i].close - ema) * multiplier + ema;
                emaValues[i] = ema;
            }
            return emaValues;
        }

        function calculateBollingerBands(candles, period, stdDev) {
            if (candles.length < period) {
                return {
                    upper: new Array(candles.length).fill(null),
                    middle: new Array(candles.length).fill(null),
                    lower: new Array(candles.length).fill(null)
                };
            }
            
            const upper = new Array(candles.length).fill(null);
            const middle = new Array(candles.length).fill(null);
            const lower = new Array(candles.length).fill(null);
            
            for (let i = period - 1; i < candles.length; i++) {
                // Calculate SMA
                let sum = 0;
                for (let j = 0; j < period; j++) {
                    sum += candles[i - j].close;
                }
                const sma = sum / period;
                
                // Calculate standard deviation
                let variance = 0;
                for (let j = 0; j < period; j++) {
                    variance += Math.pow(candles[i - j].close - sma, 2);
                }
                const std = Math.sqrt(variance / period);
                
                upper[i] = sma + (std * stdDev);
                middle[i] = sma;
                lower[i] = sma - (std * stdDev);
            }
            
            return { upper, middle, lower };
        }

        // WebSocket connection (simulated for now)
        function connectToDeriv() {
            // Simulate connection
            setTimeout(() => {
                updateConnectionStatus('Connected');
                document.getElementById('chartLoading').style.display = 'none';
                updatePriceDisplay();
            }, 1000);
        }

        function updateConnectionStatus(status) {
            document.getElementById('connectionStatus').textContent = status;
        }

        function updatePriceDisplay() {
            document.getElementById('lastPrice').textContent = currentPrice.toFixed(2);
            document.getElementById('currentPrice').textContent = currentPrice.toFixed(2);
            
            const priceElement = document.getElementById('currentPrice');
            if (currentPrice > previousPrice) {
                priceElement.className = 'price-value up';
            } else if (currentPrice < previousPrice) {
                priceElement.className = 'price-value down';
            }
            
            // Update tick indicator
            const indicator = document.getElementById('tickIndicator');
            if (currentPrice > previousPrice) {
                indicator.textContent = '‚Üë';
                indicator.className = 'tick-indicator up';
            } else if (currentPrice < previousPrice) {
                indicator.textContent = '‚Üì';
                indicator.className = 'tick-indicator down';
            } else {
                indicator.textContent = '-';
                indicator.className = 'tick-indicator';
            }
        }

        // Simulate tick updates
        function simulateTickUpdate() {
            setInterval(() => {
                if (candles.length === 0) return;
                
                previousPrice = currentPrice;
                
                // Generate a small random price change
                const change = (Math.random() - 0.5) * 10;
                currentPrice += change;
                
                // Update last candle
                const lastCandle = candles[candles.length - 1];
                lastCandle.close = currentPrice;
                lastCandle.high = Math.max(lastCandle.high, currentPrice);
                lastCandle.low = Math.min(lastCandle.low, currentPrice);
                
                // Update tick count
                tickCount++;
                document.getElementById('tickCount').textContent = tickCount;
                
                // Update price display
                updatePriceDisplay();
                
                // Update price change percentage
                if (previousPrice > 0) {
                    const changePercent = ((currentPrice - previousPrice) / previousPrice) * 100;
                    document.getElementById('priceChange').textContent = 
                        `${changePercent >= 0 ? '+' : ''}${changePercent.toFixed(2)}%`;
                }
                
                // Redraw chart
                drawChart();
            }, 1000); // Update every second
        }

        // Initialize
        function init() {
            initTheme();
            initChart();
            connectToDeriv();
            simulateTickUpdate();
            
            // Event listeners
            document.getElementById('candleBtn').addEventListener('click', () => {
                chartType = 'candlestick';
                document.getElementById('candleBtn').classList.add('active');
                document.getElementById('lineBtn').classList.remove('active');
                drawChart();
            });
            
            document.getElementById('lineBtn').addEventListener('click', () => {
                chartType = 'line';
                document.getElementById('lineBtn').classList.add('active');
                document.getElementById('candleBtn').classList.remove('active');
                drawChart();
            });
            
            document.querySelectorAll('.timeframe-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    document.querySelectorAll('.timeframe-btn').forEach(b => b.classList.remove('active'));
                    e.target.classList.add('active');
                    activeTimeframe = parseInt(e.target.dataset.timeframe);
                    
                    // Regenerate candles for new timeframe
                    candles = generateSampleCandles();
                    currentPrice = candles[candles.length - 1]?.close || 0;
                    drawChart();
                });
            });
            
            // Handle window resize
            window.addEventListener('resize', () => {
                if (canvas) {
                    canvas.width = canvas.offsetWidth;
                    canvas.height = canvas.offsetHeight;
                    drawChart();
                }
            });
            
            // Update symbol info
            document.getElementById('symbolName').textContent = SYMBOLS[activeSymbol]?.name || 'Unknown Symbol';
        }

        // Start everything
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
