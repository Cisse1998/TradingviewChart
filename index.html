<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Digits Analysis Terminal + Suggestions & History + Signal Scanner + Rise/Fall</title>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root {
      --background: 15 15 15;
      --card: 26 26 26;
      --secondary: 38 38 38;
      --border: 51 51 51;
      --primary: 59 130 246;
      --destructive: 239 68 68;
      --profit: 16 185 129;
      --loss: 239 68 68;
      --highlight: 245 158 11;
      --accent: 139 92 246;
      --foreground: 255 255 255;
      --muted-foreground: 161 161 170;
    }
    body { background-color: rgb(var(--background)); color: rgb(var(--foreground)); font-family: ui-monospace, monospace; }
    .bg-background { background-color: rgb(var(--background)); }
    .bg-card { background-color: rgb(var(--card)); }
    .bg-secondary { background-color: rgb(var(--secondary)); }
    .bg-primary { background-color: rgb(var(--primary)); }
    .bg-destructive { background-color: rgb(var(--destructive)); }
    .bg-profit { background-color: rgb(var(--profit)); }
    .bg-loss { background-color: rgb(var(--loss)); }
    .bg-highlight { background-color: rgb(var(--highlight)); }
    .bg-accent { background-color: rgb(var(--accent)); }
    .border-border { border-color: rgb(var(--border)); }
    .text-foreground { color: rgb(var(--foreground)); }
    .text-muted-foreground { color: rgb(var(--muted-foreground)); }
    .text-primary { color: rgb(var(--primary)); }
    .text-profit { color: rgb(var(--profit)); }
    .text-loss { color: rgb(var(--loss)); }
    .text-highlight { color: rgb(var(--highlight)); }
    .text-accent { color: rgb(var(--accent)); }
    .animate-pulse-glow {
      animation: pulse-glow 1.5s ease-in-out infinite;
    }
    @keyframes pulse-glow {
      0%, 100% { opacity: 1; text-shadow: 0 0 5px rgb(var(--profit)); }
      50% { opacity: 0.5; text-shadow: 0 0 12px rgb(var(--profit)); }
    }
    .font-mono { font-family: 'Menlo', 'Courier New', monospace; }
  </style>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="bg-background">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useMemo, useCallback, useEffect, useRef } = React;

    // ---------- constants ----------
    const DERIV_WS_URL = "wss://ws.binaryws.com/websockets/v3?app_id=1089";
    const VOLATILITY_SYMBOLS = [
      // Jump Indices
      { value: "JD10", label: "Jump 10 Index" },
      { value: "JD25", label: "Jump 25 Index" },
      { value: "JD50", label: "Jump 50 Index" },
      { value: "JD75", label: "Jump 75 Index" },
      { value: "JD100", label: "Jump 100 Index" },
      // Volatility Indices
      { value: "R_10", label: "Volatility 10 Index" },
      { value: "R_25", label: "Volatility 25 Index" },
      { value: "R_50", label: "Volatility 50 Index" },
      { value: "R_75", label: "Volatility 75 Index" },
      { value: "R_100", label: "Volatility 100 Index" },
      // Volatility Indices (1s)
      { value: "1HZ10V", label: "Volatility 10 (1s) Index" },
      { value: "1HZ15V", label: "Volatility 15 (1s) Index" },
      { value: "1HZ25V", label: "Volatility 25 (1s) Index" },
      { value: "1HZ30V", label: "Volatility 30 (1s) Index" },
      { value: "1HZ50V", label: "Volatility 50 (1s) Index" },
      { value: "1HZ75V", label: "Volatility 75 (1s) Index" },
      { value: "1HZ90V", label: "Volatility 90 (1s) Index" },
      { value: "1HZ100V", label: "Volatility 100 (1s) Index" },
    ];

    // Fallback decimal places based on your examples (if API fails)
    const DECIMAL_FALLBACK = {
      '1HZ10V': 2,
      'R_10': 3,
      '1HZ15V': 3,
      '1HZ25V': 2,
      'R_25': 3,
      '1HZ30V': 3,
      '1HZ50V': 2,
      'R_50': 4,
      '1HZ75V': 2,
      'R_75': 4,
      '1HZ90V': 3,
      '1HZ100V': 2,
      'R_100': 2,
      'JD10': 2,
      'JD25': 2,
      'JD50': 2,
      'JD75': 2,
      'JD100': 2,
    };

    // ---------- helper: extract last digit from a formatted price string ----------
    function getLastDigitFromPrice(priceStr) {
      const dotIndex = priceStr.indexOf('.');
      if (dotIndex === -1) {
        return parseInt(priceStr.slice(-1), 10);
      } else {
        const decimalPart = priceStr.slice(dotIndex + 1);
        return parseInt(decimalPart.slice(-1), 10);
      }
    }

    // ---------- fetch symbol details to get decimal places ----------
    async function fetchDecimalPlaces(symbol) {
      try {
        const response = await fetch(`https://api.deriv.com/api/v3/symbols?symbols=${symbol}&app_id=1089`);
        const data = await response.json();
        if (data.symbols && data.symbols[0]) {
          const info = data.symbols[0];
          if (info.decimal_places !== undefined) {
            return info.decimal_places;
          } else if (info.pip_size) {
            return Math.round(Math.log10(1 / info.pip_size));
          }
        }
      } catch (e) {
        console.error("Failed to fetch symbol details", e);
      }
      return DECIMAL_FALLBACK[symbol] || 3;
    }

    // ---------- websocket (passes raw price number) ----------
    function connectDeriv() {
      let ws = null;
      let subscriptionId = null;

      const subscribe = (symbol, onTick) => {
        if (ws) ws.close();

        ws = new WebSocket(DERIV_WS_URL);

        ws.onopen = () => {
          ws?.send(JSON.stringify({ ticks: symbol, subscribe: 1 }));
        };

        ws.onmessage = (event) => {
          try {
            const data = JSON.parse(event.data);
            if (data.tick) {
              subscriptionId = data.tick.id;
              const rawPrice = data.tick.quote;
              onTick(rawPrice);
            }
          } catch (e) { }
        };

        ws.onerror = () => {
          console.error("Deriv WebSocket error");
        };
      };

      const unsubscribe = () => {
        if (ws && subscriptionId) {
          ws.send(JSON.stringify({ forget: subscriptionId }));
          subscriptionId = null;
        }
      };

      const disconnect = () => {
        unsubscribe();
        if (ws) {
          ws.close();
          ws = null;
        }
      };

      return { subscribe, unsubscribe, disconnect };
    }

    // ---------- analysis functions ----------
    function computeDigitFrequency(digits) {
      const total = digits.length;
      const counts = Array(10).fill(0);
      digits.forEach(d => counts[d]++);
      return counts.map((count, digit) => ({ digit, count, percentage: total > 0 ? (count / total) * 100 : 0 }));
    }
    function computeOverUnder(digits) {
      const total = digits.length;
      return Array.from({ length: 10 }, (_, target) => {
        const overCount = digits.filter(d => d > target).length;
        const underCount = digits.filter(d => d < target).length;
        return { digit: target, overCount, overPercentage: total > 0 ? (overCount / total) * 100 : 0, underCount, underPercentage: total > 0 ? (underCount / total) * 100 : 0 };
      });
    }
    function computeMatchDiffer(digits) {
      const total = digits.length;
      return Array.from({ length: 10 }, (_, target) => {
        const matchCount = digits.filter(d => d === target).length;
        return { digit: target, matchCount, matchPercentage: total > 0 ? (matchCount / total) * 100 : 0, differCount: total - matchCount, differPercentage: total > 0 ? ((total - matchCount) / total) * 100 : 0 };
      });
    }
    function computeEvenOdd(digits) {
      const total = digits.length;
      const evenCount = digits.filter(d => d % 2 === 0).length;
      return { evenCount, evenPercentage: total > 0 ? (evenCount / total) * 100 : 0, oddCount: total - evenCount, oddPercentage: total > 0 ? ((total - evenCount) / total) * 100 : 0 };
    }
    function computeStreaks(digits) {
      let curEven = 0, curOdd = 0, maxEven = 0, maxOdd = 0;
      const curDigit = Array(10).fill(0);
      const maxDigit = Array(10).fill(0);
      for (const d of digits) {
        if (d % 2 === 0) { curEven++; maxEven = Math.max(maxEven, curEven); curOdd = 0; }
        else { curOdd++; maxOdd = Math.max(maxOdd, curOdd); curEven = 0; }
        for (let i = 0; i < 10; i++) {
          if (i === d) { curDigit[i]++; maxDigit[i] = Math.max(maxDigit[i], curDigit[i]); }
          else { curDigit[i] = 0; }
        }
      }
      return { currentEvenStreak: curEven, currentOddStreak: curOdd, longestEvenStreak: maxEven, longestOddStreak: maxOdd, digitStreaks: Array.from({ length: 10 }, (_, i) => ({ digit: i, current: curDigit[i], longest: maxDigit[i] })) };
    }

    // Rise/Fall analysis
    function computeRiseFall(prices) {
      if (prices.length < 2) return { riseCount: 0, fallCount: 0, sameCount: 0, totalMovements: 0, risePercent: 0, fallPercent: 0 };
      let rise = 0, fall = 0, same = 0;
      for (let i = 1; i < prices.length; i++) {
        const prev = prices[i-1];
        const curr = prices[i];
        if (curr > prev) rise++;
        else if (curr < prev) fall++;
        else same++;
      }
      const total = rise + fall + same;
      return {
        riseCount: rise,
        fallCount: fall,
        sameCount: same,
        totalMovements: total,
        risePercent: total > 0 ? (rise / total) * 100 : 0,
        fallPercent: total > 0 ? (fall / total) * 100 : 0,
        samePercent: total > 0 ? (same / total) * 100 : 0
      };
    }

    // ---------- components ----------
    function AnalysisCard({ title, subtitle, children }) {
      return (
        <div className="bg-card border border-border rounded-lg p-5">
          <div className="mb-4"><h3 className="font-semibold text-foreground text-sm uppercase tracking-wider">{title}</h3>{subtitle && <p className="text-muted-foreground text-xs mt-1">{subtitle}</p>}</div>
          {children}
        </div>
      );
    }

    function DigitBar({ digit, percentage, maxPercentage = 100, color = "highlight" }) {
      const width = Math.max((percentage / maxPercentage) * 100, 2);
      const isHigh = percentage > 12;
      const isLow = percentage < 8;
      const colorMap = { profit: "bg-profit", loss: "bg-loss", highlight: "bg-highlight", accent: "bg-accent" };
      const barColor = isHigh ? "bg-profit" : isLow ? "bg-loss" : colorMap[color];
      return (
        <div className="flex items-center gap-3 group">
          <span className="font-mono text-sm w-6 text-muted-foreground font-semibold">{digit}</span>
          <div className="flex-1 h-7 bg-secondary rounded-sm overflow-hidden relative"><div className={`h-full rounded-sm transition-all duration-500 ${barColor}`} style={{ width: `${width}%` }} /></div>
          <span className={`font-mono text-sm w-16 text-right font-semibold ${isHigh ? "text-profit" : isLow ? "text-loss" : "text-foreground"}`}>{percentage.toFixed(1)}%</span>
        </div>
      );
    }

    function EvenOddDisplay({ data }) {
      return (
        <div className="flex gap-4">
          <div className="flex-1 bg-secondary rounded-lg p-4 text-center"><div className="text-xs text-muted-foreground uppercase tracking-wider mb-2">Even</div><div className="font-mono text-2xl font-bold text-profit">{data.evenPercentage.toFixed(1)}%</div><div className="text-xs text-muted-foreground mt-1">{data.evenCount} ticks</div></div>
          <div className="flex-1 bg-secondary rounded-lg p-4 text-center"><div className="text-xs text-muted-foreground uppercase tracking-wider mb-2">Odd</div><div className="font-mono text-2xl font-bold text-loss">{data.oddPercentage.toFixed(1)}%</div><div className="text-xs text-muted-foreground mt-1">{data.oddCount} ticks</div></div>
        </div>
      );
    }

    function OverUnderTable({ data }) {
      return (
        <div className="overflow-x-auto"><table className="w-full text-sm font-mono"><thead><tr className="text-muted-foreground text-xs uppercase tracking-wider"><th className="text-left py-2 px-2">Digit</th><th className="text-right py-2 px-2">Over %</th><th className="text-right py-2 px-2">Under %</th></tr></thead><tbody>{data.map(row => (<tr key={row.digit} className="border-t border-border hover:bg-secondary/50 transition-colors"><td className="py-2 px-2 font-semibold">{row.digit}</td><td className="py-2 px-2 text-right text-profit">{row.overPercentage.toFixed(1)}%</td><td className="py-2 px-2 text-right text-loss">{row.underPercentage.toFixed(1)}%</td></tr>))}</tbody></table></div>
      );
    }

    function MatchDifferTable({ data }) {
      return (
        <div className="overflow-x-auto"><table className="w-full text-sm font-mono"><thead><tr className="text-muted-foreground text-xs uppercase tracking-wider"><th className="text-left py-2 px-2">Digit</th><th className="text-right py-2 px-2">Matches %</th><th className="text-right py-2 px-2">Differs %</th></tr></thead><tbody>{data.map(row => (<tr key={row.digit} className="border-t border-border hover:bg-secondary/50 transition-colors"><td className="py-2 px-2 font-semibold">{row.digit}</td><td className="py-2 px-2 text-right text-highlight">{row.matchPercentage.toFixed(1)}%</td><td className="py-2 px-2 text-right text-accent">{row.differPercentage.toFixed(1)}%</td></tr>))}</tbody></table></div>
      );
    }

    function StreakDisplay({ data }) {
      return (
        <div className="space-y-4">
          <div className="flex gap-4">
            <div className="flex-1 bg-secondary rounded-lg p-3 text-center"><div className="text-xs text-muted-foreground uppercase tracking-wider mb-1">Even Streak</div><div className="flex items-baseline justify-center gap-2"><span className="font-mono text-xl font-bold text-profit">{data.longestEvenStreak}</span><span className="text-xs text-muted-foreground">longest</span></div><div className="text-xs text-muted-foreground mt-1">current: <span className="font-mono text-foreground">{data.currentEvenStreak}</span></div></div>
            <div className="flex-1 bg-secondary rounded-lg p-3 text-center"><div className="text-xs text-muted-foreground uppercase tracking-wider mb-1">Odd Streak</div><div className="flex items-baseline justify-center gap-2"><span className="font-mono text-xl font-bold text-loss">{data.longestOddStreak}</span><span className="text-xs text-muted-foreground">longest</span></div><div className="text-xs text-muted-foreground mt-1">current: <span className="font-mono text-foreground">{data.currentOddStreak}</span></div></div>
          </div>
          <div><div className="text-xs text-muted-foreground uppercase tracking-wider mb-2">Consecutive per Digit</div><div className="grid grid-cols-5 gap-2">{data.digitStreaks.map(s => (<div key={s.digit} className="bg-secondary rounded p-2 text-center"><div className="font-mono text-xs text-highlight font-bold mb-1">{s.digit}</div><div className="font-mono text-sm font-bold text-foreground">{s.longest}</div><div className="text-[10px] text-muted-foreground">now {s.current}</div></div>))}</div></div>
        </div>
      );
    }

    // Rise/Fall Card
    function RiseFallCard({ data }) {
      return (
        <AnalysisCard title="üìä Rise / Fall Analysis" subtitle="Tick-to-tick price movement">
          <div className="flex gap-4">
            <div className="flex-1 bg-secondary rounded-lg p-4 text-center">
              <div className="text-xs text-muted-foreground uppercase tracking-wider mb-2">Rise</div>
              <div className="font-mono text-2xl font-bold text-profit">{data.risePercent.toFixed(1)}%</div>
              <div className="text-xs text-muted-foreground mt-1">{data.riseCount} ticks</div>
            </div>
            <div className="flex-1 bg-secondary rounded-lg p-4 text-center">
              <div className="text-xs text-muted-foreground uppercase tracking-wider mb-2">Fall</div>
              <div className="font-mono text-2xl font-bold text-loss">{data.fallPercent.toFixed(1)}%</div>
              <div className="text-xs text-muted-foreground mt-1">{data.fallCount} ticks</div>
            </div>
            {data.sameCount > 0 && (
              <div className="flex-1 bg-secondary rounded-lg p-4 text-center">
                <div className="text-xs text-muted-foreground uppercase tracking-wider mb-2">Same</div>
                <div className="font-mono text-2xl font-bold text-muted-foreground">{data.samePercent.toFixed(1)}%</div>
                <div className="text-xs text-muted-foreground mt-1">{data.sameCount} ticks</div>
              </div>
            )}
          </div>
        </AnalysisCard>
      );
    }

    // ---------- trading suggestions card ----------
    function SuggestionCard({ frequency }) {
      if (!frequency || frequency.length === 0) return null;
      const deviations = frequency.map(f => ({ digit: f.digit, dev: f.percentage - 10 }));
      const sorted = [...deviations].sort((a, b) => Math.abs(b.dev) - Math.abs(a.dev));
      const topOver = sorted.filter(d => d.dev > 0).slice(0, 3);
      const topUnder = sorted.filter(d => d.dev < 0).slice(0, 3);

      return (
        <AnalysisCard title="üìà Trading Suggestions" subtitle="Digits deviating most from 10% (potential mean reversion)">
          <div className="flex flex-wrap gap-6">
            <div className="flex-1 min-w-[200px]">
              <h4 className="text-xs uppercase tracking-wider text-profit mb-2">üî¥ Overrepresented (may sell)</h4>
              {topOver.length === 0 ? <p className="text-muted-foreground text-sm">None</p> : 
                topOver.map(d => <div key={d.digit} className="flex justify-between items-center text-sm py-1 border-b border-border/50"><span className="font-mono">Digit {d.digit}</span><span className="text-profit font-mono">+{d.dev.toFixed(1)}%</span></div>)}
            </div>
            <div className="flex-1 min-w-[200px]">
              <h4 className="text-xs uppercase tracking-wider text-loss mb-2">üü¢ Underrepresented (may buy)</h4>
              {topUnder.length === 0 ? <p className="text-muted-foreground text-sm">None</p> : 
                topUnder.map(d => <div key={d.digit} className="flex justify-between items-center text-sm py-1 border-b border-border/50"><span className="font-mono">Digit {d.digit}</span><span className="text-loss font-mono">{d.dev.toFixed(1)}%</span></div>)}
            </div>
          </div>
        </AnalysisCard>
      );
    }

    // ---------- history chart ----------
    function HistoryChart({ history }) {
      if (!history || history.length < 2) return (
        <div className="text-muted-foreground text-sm py-4 text-center">Collecting history (snapshots every 10 ticks)...</div>
      );

      const latest = history[history.length-1];
      const devs = latest.map((pct, idx) => ({ digit: idx, dev: Math.abs(pct-10) })).sort((a,b) => b.dev - a.dev);
      const topDigits = devs.slice(0,4).map(d => d.digit);

      const colors = ["#10b981", "#ef4444", "#f59e0b", "#8b5cf6"];
      const width = 400, height = 120;
      const points = history.map((freqs, idx) => {
        const x = (idx / (history.length-1)) * width;
        return { x, freqs };
      });

      return (
        <div className="w-full overflow-x-auto">
          <svg viewBox={`0 0 ${width} ${height}`} className="w-full h-auto max-h-32" preserveAspectRatio="none">
            {topDigits.map((digit, lineIdx) => {
              const color = colors[lineIdx % colors.length];
              const linePoints = points.map(p => `${p.x},${height - (p.freqs[digit] / 15) * height}`).join(' ');
              return (
                <g key={digit}>
                  <polyline points={linePoints} stroke={color} strokeWidth="2" fill="none" />
                  <text x="5" y={20 + lineIdx*18} fill={color} fontSize="10" className="font-mono">{`Digit ${digit}`}</text>
                </g>
              );
            })}
          </svg>
          <div className="flex justify-between text-[10px] text-muted-foreground mt-1">
            <span>earliest</span><span>latest</span>
          </div>
        </div>
      );
    }

    // ---------- Signal Scanner Component ----------
    function SignalScanner({ frequency, lastDigit }) {
      const [scannerActive, setScannerActive] = useState(false);
      const [lastSignal, setLastSignal] = useState(null);

      const prediction = useMemo(() => {
        if (!frequency || frequency.length === 0) return null;
        const max = frequency.reduce((a, b) => a.percentage > b.percentage ? a : b);
        const highestPct = max.percentage;
        const targetPct = highestPct - 0.5 - 0.5;
        const closest = frequency.reduce((prev, curr) => {
          return Math.abs(curr.percentage - targetPct) < Math.abs(prev.percentage - targetPct) ? curr : prev;
        });
        return { triggerDigit: max.digit, targetDigit: closest.digit, targetPct };
      }, [frequency]);

      useEffect(() => {
        if (scannerActive && prediction && lastDigit === prediction.triggerDigit) {
          setLastSignal({ ...prediction, timestamp: Date.now() });
        }
      }, [lastDigit, prediction, scannerActive]);

      const toggleScanner = () => {
        setScannerActive(prev => !prev);
        setLastSignal(null);
      };

      return (
        <AnalysisCard title="üîî Signal Scanner" subtitle="Tracks last 1000 digits ‚Äì triggers when most frequent digit appears">
          <div className="flex items-center justify-between mb-3">
            <button
              onClick={toggleScanner}
              className={`px-4 py-1.5 rounded text-sm font-semibold transition-colors ${
                scannerActive 
                  ? 'bg-destructive text-destructive-foreground hover:bg-destructive/80' 
                  : 'bg-primary text-primary-foreground hover:bg-primary/80'
              }`}
            >
              {scannerActive ? '‚èπ Stop Scanner' : '‚ñ∂ Start Scanner'}
            </button>
            {scannerActive && <span className="text-xs text-profit animate-pulse">‚óè SCANNING</span>}
          </div>

          {prediction ? (
            <div>
              <p className="text-sm">
                <span className="text-muted-foreground">Trigger digit:</span>{' '}
                <span className="font-bold text-highlight text-lg">{prediction.triggerDigit}</span>{' '}
                <span className="text-muted-foreground">({frequency.find(f => f.digit === prediction.triggerDigit)?.percentage.toFixed(1)}%)</span>
              </p>
              <p className="text-sm mt-1">
                <span className="text-muted-foreground">Target digit:</span>{' '}
                <span className="font-bold text-profit text-lg">{prediction.targetDigit}</span>{' '}
                <span className="text-muted-foreground">(closest to {prediction.targetPct.toFixed(1)}%)</span>
              </p>
              {lastSignal && scannerActive && (
                <div className="mt-3 p-3 bg-profit/20 border border-profit rounded-md animate-pulse">
                  <span className="font-mono text-sm">‚ö° SIGNAL ‚Äî Digit {prediction.triggerDigit} to be predicted! Entry digit is {prediction.targetDigit}</span>
                </div>
              )}
            </div>
          ) : (
            <p className="text-muted-foreground">Waiting for enough data...</p>
          )}
        </AnalysisCard>
      );
    }

    // Recent Movements Card (displays R/F/= for last 50 ticks)
    function RecentMovements({ prices }) {
      const getMovement = (index) => {
        if (index === 0 || prices.length < 2) return '‚Äî';
        const prev = prices[index-1];
        const curr = prices[index];
        if (curr > prev) return 'R';
        if (curr < prev) return 'F';
        return '=';
      };

      // Show last 50 movements (newest first)
      const last50 = prices.slice(-50).reverse();
      const last50Indices = prices.slice(-50).map((_, idx) => prices.length - 50 + idx).reverse();

      return (
        <AnalysisCard title="üìà Tick Movements (last 50)" subtitle="R=Rise, F=Fall, = =Same, ‚Äî =First tick">
          <div className="flex flex-wrap gap-1.5">
            {last50.map((price, i) => {
              const originalIndex = last50Indices[i];
              const movement = getMovement(originalIndex);
              return (
                <div key={i} className={`w-8 h-8 flex items-center justify-center rounded text-xs font-mono font-bold ${
                  movement === 'R' ? 'bg-profit/15 text-profit' : 
                  movement === 'F' ? 'bg-loss/15 text-loss' : 
                  'bg-secondary text-muted-foreground'
                }`}>
                  {movement}
                </div>
              );
            })}
          </div>
        </AnalysisCard>
      );
    }

    // ---------- main App ----------
    function Index() {
      const [maxTicks, setMaxTicks] = useState(1000);
      const [inputValue, setInputValue] = useState("1000");
      const [digits, setDigits] = useState([]);
      const [prices, setPrices] = useState([]);
      const [symbol, setSymbol] = useState("R_100");
      const [isLive, setIsLive] = useState(false);
      const [lastPrice, setLastPrice] = useState(null);
      const [decimalPlaces, setDecimalPlaces] = useState(3);
      const connectionRef = useRef(null);

      const [freqHistory, setFreqHistory] = useState([]);
      const lastSnapshotLength = useRef(0);

      useEffect(() => {
        let active = true;
        const load = async () => {
          const dp = await fetchDecimalPlaces(symbol);
          if (active) setDecimalPlaces(dp);
        };
        load();
        return () => { active = false; };
      }, [symbol]);

      useEffect(() => {
        if (digits.length === 0) return;
        if (digits.length % 10 === 0 && digits.length > lastSnapshotLength.current) {
          lastSnapshotLength.current = digits.length;
          const freqs = computeDigitFrequency(digits).map(f => f.percentage);
          setFreqHistory(prev => {
            const updated = [...prev, freqs];
            return updated.slice(-30);
          });
        }
      }, [digits]);

      const resetHistory = useCallback(() => {
        setFreqHistory([]);
        lastSnapshotLength.current = 0;
      }, []);

      const frequency = useMemo(() => computeDigitFrequency(digits), [digits]);
      const overUnder = useMemo(() => computeOverUnder(digits), [digits]);
      const matchDiffer = useMemo(() => computeMatchDiffer(digits), [digits]);
      const evenOdd = useMemo(() => computeEvenOdd(digits), [digits]);
      const streaks = useMemo(() => computeStreaks(digits), [digits]);
      const riseFall = useMemo(() => computeRiseFall(prices), [prices]);
      const maxFreqPct = useMemo(() => Math.max(...frequency.map(f => f.percentage), 15), [frequency]);

      const startStream = useCallback(() => {
        if (connectionRef.current) connectionRef.current.disconnect();
        setDigits([]);
        setPrices([]);
        setLastPrice(null);
        resetHistory();
        const conn = connectDeriv();
        connectionRef.current = conn;
        setIsLive(true);

        conn.subscribe(symbol, (rawPrice) => {
          const formatted = rawPrice.toFixed(decimalPlaces);
          const digit = getLastDigitFromPrice(formatted);
          setLastPrice(formatted);
          setDigits(prev => {
            const next = [...prev, digit];
            return next.length > maxTicks ? next.slice(next.length - maxTicks) : next;
          });
          setPrices(prev => {
            const next = [...prev, rawPrice];
            return next.length > maxTicks ? next.slice(next.length - maxTicks) : next;
          });
        });
      }, [symbol, maxTicks, resetHistory, decimalPlaces]);

      const stopStream = useCallback(() => {
        connectionRef.current?.disconnect();
        connectionRef.current = null;
        setIsLive(false);
      }, []);

      useEffect(() => {
        return () => connectionRef.current?.disconnect();
      }, []);

      const handleMaxTicksChange = () => {
        const count = Math.max(10, Math.min(50000, parseInt(inputValue) || 1000));
        setMaxTicks(count);
        setInputValue(String(count));
        setDigits(prev => (prev.length > count ? prev.slice(prev.length - count) : prev));
        setPrices(prev => (prev.length > count ? prev.slice(prev.length - count) : prev));
        resetHistory();
      };

      const selectedLabel = VOLATILITY_SYMBOLS.find(s => s.value === symbol)?.label || symbol;
      const currentDigit = digits.length > 0 ? digits[digits.length - 1] : null;

      // Compute current consecutive streak length
      const currentStreak = useMemo(() => {
        if (digits.length === 0) return 0;
        let streak = 1;
        for (let i = digits.length - 2; i >= 0; i--) {
          if (digits[i] === digits[digits.length - 1]) streak++;
          else break;
        }
        return streak;
      }, [digits]);

      // Function to determine text color based on streak length
      const getStreakColor = (streak) => {
        if (streak === 1) return 'text-profit';
        if (streak === 2) return 'text-white';
        if (streak === 3) return 'text-blue-400';
        if (streak === 4) return 'text-yellow-400';
        if (streak >= 5) return 'text-purple-400';
        return 'text-profit';
      };

      // Prepare recent digits with consecutive detection
      const recentDigits = useMemo(() => digits.slice(-50).reverse(), [digits]);
      const consecutiveFlags = useMemo(() => {
        const flags = new Array(recentDigits.length).fill(false);
        for (let i = 0; i < recentDigits.length; i++) {
          if (i > 0 && recentDigits[i] === recentDigits[i-1]) {
            flags[i] = true;
            flags[i-1] = true;
          }
        }
        return flags;
      }, [recentDigits]);

      return (
        <div className="min-h-screen bg-background">
          <header className="border-b border-border px-6 py-4">
            <div className="max-w-7xl mx-auto flex items-center justify-between flex-wrap gap-3">
              <div>
                <h1 className="text-xl font-bold text-foreground tracking-tight"><span className="text-primary">‚óè</span> Digit Analysis Terminal + Suggestion & History + Signal Scanner + Rise/Fall + Consecutive Colors</h1>
                <p className="text-xs text-muted-foreground mt-0.5">Deriv Synthetic Indices ‚Äî Live Digit Analysis</p>
              </div>
              <div className="flex items-center gap-3 text-xs font-mono">
                {isLive && <span className="flex items-center gap-1.5 text-profit"><span className="animate-pulse-glow">‚óè</span> LIVE</span>}
                <span className="text-muted-foreground">{digits.length.toLocaleString()} ticks</span>
                {lastPrice && <span className="text-highlight font-semibold">{lastPrice}</span>}
              </div>
            </div>
          </header>

          <main className="max-w-7xl mx-auto px-6 py-6 space-y-6">
            <div className="bg-card border border-border rounded-lg p-4 flex flex-wrap items-center gap-4">
              <div className="flex items-center gap-2">
                <label className="text-sm text-muted-foreground">Symbol:</label>
                <select value={symbol} onChange={e => setSymbol(e.target.value)} disabled={isLive} className="bg-secondary border border-border rounded px-3 py-1.5 text-sm font-mono text-foreground focus:outline-none focus:ring-1 focus:ring-primary disabled:opacity-50">
                  {VOLATILITY_SYMBOLS.map(s => <option key={s.value} value={s.value}>{s.label}</option>)}
                </select>
              </div>
              <div className="flex items-center gap-2">
                <label className="text-sm text-muted-foreground">Max ticks:</label>
                <input type="number" value={inputValue} onChange={e => setInputValue(e.target.value)} onKeyDown={e => e.key === "Enter" && handleMaxTicksChange()} onBlur={handleMaxTicksChange} min={10} max={50000} className="bg-secondary border border-border rounded px-3 py-1.5 text-sm font-mono text-foreground w-24 focus:outline-none focus:ring-1 focus:ring-primary" />
              </div>
              <div className="flex gap-2 ml-auto">
                {!isLive ? <button onClick={startStream} className="bg-primary text-primary-foreground px-5 py-1.5 rounded text-sm font-semibold hover:opacity-90 transition-opacity">‚ñ∂ Start Live</button> :
                <button onClick={stopStream} className="bg-destructive text-destructive-foreground px-5 py-1.5 rounded text-sm font-semibold hover:opacity-90 transition-opacity">‚ñ† Stop</button>}
              </div>
            </div>

            {digits.length === 0 && !isLive && (
              <div className="bg-card border border-border rounded-lg p-12 text-center">
                <p className="text-muted-foreground text-lg mb-2">Select a symbol and click <strong className="text-primary">Start Live</strong> to begin</p>
                <p className="text-muted-foreground text-sm">Real-time tick data from Deriv's synthetic indices</p>
              </div>
            )}

            {digits.length > 0 && (
              <>
                <AnalysisCard title="Digit Frequency" subtitle={`${selectedLabel} ‚Äî ${digits.length.toLocaleString()} ticks (expected: 10.0% each)`}>
                  <div className="space-y-1.5">{frequency.map(f => <DigitBar key={f.digit} digit={f.digit} percentage={f.percentage} maxPercentage={maxFreqPct} />)}</div>
                </AnalysisCard>

                <SuggestionCard frequency={frequency} />

                <SignalScanner frequency={frequency} lastDigit={currentDigit} />

                {/* Large last digit display with dynamic color based on streak */}
                <div className="text-6xl md:text-7xl font-bold text-center py-4 border border-profit/30 rounded-lg bg-profit/5">
                  <span className={getStreakColor(currentStreak)}>
                    {lastPrice ? getLastDigitFromPrice(lastPrice) : '--'}
                  </span>
                </div>
                <div className="text-xs text-muted-foreground text-center mt-1">
                  Last Digit {currentStreak > 1 ? `(streak: ${currentStreak})` : ''}
                </div>

                <RiseFallCard data={riseFall} />

                <RecentMovements prices={prices} />

                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                  <AnalysisCard 
                    title="Over / Under" 
                    subtitle={`Probability per digit barrier ‚Äî Current price: ${lastPrice ? lastPrice : '--'}`}
                  >
                    <OverUnderTable data={overUnder} />
                  </AnalysisCard>

                  <AnalysisCard 
                    title="Matches / Differs" 
                    subtitle={`Match & differ probability per digit ‚Äî Current price: ${lastPrice ? lastPrice : '--'}`}
                  >
                    <MatchDifferTable data={matchDiffer} />
                  </AnalysisCard>

                  <AnalysisCard 
                    title="Even / Odd" 
                    subtitle={`Even vs odd distribution ‚Äî Current price: ${lastPrice ? lastPrice : '--'}`}
                  >
                    <EvenOddDisplay data={evenOdd} />
                  </AnalysisCard>
                </div>

                {/* Recent Digits card with consecutive highlight (yellow ring) */}
                <AnalysisCard title="Recent Digits" subtitle="Last 50 ticks (newest first) ‚Äî Yellow ring indicates consecutive same digit">
                  <div className="flex flex-wrap gap-1.5">
                    {recentDigits.map((d, i) => (
                      <span key={i} className={`w-8 h-8 flex items-center justify-center rounded text-xs font-mono font-bold 
                        ${d % 2 === 0 ? "bg-profit/15 text-profit" : "bg-loss/15 text-loss"}
                        ${consecutiveFlags[i] ? "ring-2 ring-yellow-400 ring-inset" : ""}
                      `}>
                        {d}
                      </span>
                    ))}
                  </div>
                </AnalysisCard>

                <AnalysisCard title="Streak Tracking" subtitle="Longest & current consecutive streaks">
                  <StreakDisplay data={streaks} />
                </AnalysisCard>

                <AnalysisCard title="Frequency History (last 30 snapshots)" subtitle="Every 10 ticks ‚Äî lines for most deviating digits">
                  <HistoryChart history={freqHistory} />
                </AnalysisCard>
              </>
            )}
          </main>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<Index />);
  </script>
</body>
</html>
