<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tradingview Implementation for Deriv</title>
    <script src="https://cdn.socket.io/4.6.0/socket.io.min.js"></script>
    <style>
        :root {
            --background: #0a0b0e;
            --card: #111827;
            --foreground: #f8fafc;
            --primary: #3b82f6;
            --primary-foreground: #ffffff;
            --secondary: #1e293b;
            --border: #374151;
            --chart-bullish: #10b981;
            --chart-bearish: #ef4444;
            --muted-foreground: #9ca3af;
        }

        .light-mode {
            --background: #f8fafc;
            --card: #ffffff;
            --foreground: #0f172a;
            --primary: #3b82f6;
            --primary-foreground: #ffffff;
            --secondary: #f1f5f9;
            --border: #e2e8f0;
            --chart-bullish: #10b981;
            --chart-bearish: #ef4444;
            --muted-foreground: #64748b;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            transition: background-color 0.3s, color 0.3s;
        }

        body {
            background: var(--background);
            color: var(--foreground);
            min-height: 100vh;
            padding: 20px;
            line-height: 1.5;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            padding: 20px 0 30px;
            margin-bottom: 24px;
            border-bottom: 1px solid var(--border);
        }

        h1 {
            font-size: 2.5rem;
            background: linear-gradient(90deg, #3b82f6, #8b5cf6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 8px;
        }

        .status-bar {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 15px;
            font-size: 14px;
        }

        .status {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: var(--secondary);
            border-radius: 20px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .status-dot.connected {
            background-color: #10b981;
            animation: pulse 2s infinite;
        }

        .status-dot.disconnected {
            background-color: #ef4444;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .dashboard {
            display: grid;
            grid-template-columns: 1fr 320px;
            gap: 24px;
        }

        @media (max-width: 1200px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
        }

        /* Chart Area */
        .chart-area {
            background: var(--card);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid var(--border);
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border);
        }

        .symbol-info {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .symbol {
            font-size: 1.5rem;
            font-weight: 600;
        }

        .price-display {
            font-size: 1.8rem;
            font-weight: 700;
        }

        .price-up {
            color: #10b981;
        }

        .price-down {
            color: #ef4444;
        }

        .chart-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .chart-type-btn, .indicator-btn, .drawing-btn, .timeframe-btn {
            padding: 6px 12px;
            background: var(--secondary);
            border: 1px solid var(--border);
            color: var(--foreground);
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }

        .chart-type-btn:hover, .indicator-btn:hover, .drawing-btn:hover, .timeframe-btn:hover {
            background: var(--border);
        }

        .chart-type-btn.active, .timeframe-btn.active {
            background: var(--primary);
            color: var(--primary-foreground);
            border-color: var(--primary);
        }

        .indicator-btn.active {
            background: #8b5cf6;
            color: white;
            border-color: #8b5cf6;
        }

        .drawing-btn.active {
            background: #ec4899;
            color: white;
            border-color: #ec4899;
        }

        .chart-container {
            height: 450px;
            background: var(--secondary);
            border-radius: 8px;
            position: relative;
            overflow: hidden;
            border: 1px solid var(--border);
        }

        .chart-canvas-container {
            width: 100%;
            height: 100%;
            position: relative;
            cursor: crosshair;
            user-select: none;
        }

        .chart-canvas {
            width: 100%;
            height: 100%;
            display: block;
        }

        .current-price-line {
            position: absolute;
            border-top: 1px dashed var(--primary);
            width: 100%;
            pointer-events: none;
        }

        .current-price-label {
            position: absolute;
            right: 5px;
            background: var(--primary);
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 11px;
            transform: translateY(-50%);
        }

        /* Tick History */
        .tick-history {
            background: var(--card);
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
            border: 1px solid var(--border);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .tick-pattern {
            display: flex;
            gap: 4px;
            margin: 15px 0;
            flex-wrap: wrap;
        }

        .tick-rise {
            width: 24px;
            height: 24px;
            background: #10b981;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 12px;
        }

        .tick-fall {
            width: 24px;
            height: 24px;
            background: #ef4444;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 12px;
        }

        .tick-neutral {
            width: 24px;
            height: 24px;
            background: var(--muted-foreground);
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 12px;
        }

        .tick-stats {
            display: flex;
            gap: 20px;
            margin-top: 15px;
        }

        .tick-count {
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .tick-count:before {
            content: '';
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }

        .tick-count.rise:before {
            background: #10b981;
        }

        .tick-count.fall:before {
            background: #ef4444;
        }

        /* Sidebar */
        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .panel {
            background: var(--card);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid var(--border);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .panel h3 {
            margin-bottom: 15px;
            color: var(--foreground);
            font-size: 16px;
        }

        /* Dropdown Styles */
        .select-wrapper {
            position: relative;
            width: 100%;
        }

        select {
            width: 100%;
            padding: 10px 12px;
            background: var(--secondary);
            border: 1px solid var(--border);
            color: var(--foreground);
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%239ca3af' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 10px center;
            padding-right: 30px;
        }

        select:focus {
            outline: none;
            border-color: var(--primary);
        }

        .badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 600;
        }

        .badge-fast {
            background: #8b5cf6;
            color: white;
        }

        .badge-standard {
            background: var(--border);
            color: var(--foreground);
        }

        .countdown {
            text-align: center;
            padding: 8px 12px;
            background: var(--card);
            border-radius: 8px;
            margin-top: 10px;
            border: 1px solid var(--border);
        }

        .countdown-value {
            font-size: 18px;
            font-weight: 700;
            color: var(--primary);
            margin: 4px 0;
        }

        /* Instructions */
        .instructions {
            text-align: center;
            font-size: 12px;
            color: var(--muted-foreground);
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid var(--border);
        }

        /* Zoom Controls */
        .zoom-controls {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            gap: 5px;
            z-index: 10;
        }

        .zoom-btn {
            width: 30px;
            height: 30px;
            background: var(--card);
            border: 1px solid var(--border);
            color: var(--foreground);
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .zoom-btn:hover {
            background: var(--border);
        }

        /* Legend */
        .legend {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid var(--border);
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            color: var(--muted-foreground);
        }

        .legend-color {
            width: 20px;
            height: 3px;
            border-radius: 2px;
        }

        /* Tick Detector */
        .tick-detector {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .tick-indicator {
            width: 56px;
            height: 56px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            font-weight: bold;
            transition: all 0.3s;
        }

        .tick-rise-indicator {
            background: rgba(16, 185, 129, 0.2);
            border: 2px solid #10b981;
            color: #10b981;
        }

        .tick-fall-indicator {
            background: rgba(239, 68, 68, 0.2);
            border: 2px solid #ef4444;
            color: #ef4444;
        }

        .tick-neutral-indicator {
            background: rgba(156, 163, 175, 0.2);
            border: 2px solid #9ca3af;
            color: #9ca3af;
        }

        .tick-flash {
            animation: flash 0.3s;
        }

        @keyframes flash {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Theme Toggle */
        .theme-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 100;
        }

        .theme-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--secondary);
            border: 1px solid var(--border);
            color: var(--foreground);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .theme-btn:hover {
            background: var(--primary);
            color: var(--primary-foreground);
        }

        /* Indicator Panel */
        .indicator-panel {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid var(--border);
        }

        .indicator-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }

        /* MACD & CCI Indicators */
        .macd-container, .cci-container {
            height: 120px;
            background: var(--secondary);
            border-radius: 8px;
            margin-top: 10px;
            border: 1px solid var(--border);
            position: relative;
            overflow: hidden;
        }

        .macd-canvas, .cci-canvas {
            width: 100%;
            height: 100%;
            display: block;
        }

        .macd-controls, .cci-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .macd-toggle, .cci-toggle {
            padding: 4px 12px;
            background: var(--secondary);
            border: 1px solid var(--border);
            color: var(--foreground);
            border-radius: 6px;
            cursor: pointer;
            font-size: 11px;
            transition: all 0.2s;
        }

        .macd-toggle.active, .cci-toggle.active {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }

        .macd-toggle:hover, .cci-toggle:hover {
            background: var(--border);
        }

        /* Candle Countdown */
        .candle-countdown {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 10;
            background: rgba(0, 0, 0, 0.7);
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid var(--border);
            backdrop-filter: blur(10px);
        }

        .candle-countdown-label {
            font-size: 10px;
            color: var(--muted-foreground);
            margin-bottom: 2px;
        }

        .candle-countdown-value {
            font-size: 18px;
            font-weight: 700;
            color: #3b82f6;
            font-variant-numeric: tabular-nums;
        }

        /* Controls Row */
        .controls-row {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: center;
            gap: 16px;
            margin-bottom: 16px;
        }

        .left-controls, .right-controls {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
        }

        .divider {
            width: 1px;
            height: 20px;
            background: var(--border);
        }

        /* TradingView Widget Styles */
        #tradingview_chart {
            width: 100%;
            height: 100%;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .dashboard {
                gap: 16px;
            }
            
            .chart-header {
                flex-direction: column;
                gap: 15px;
                align-items: flex-start;
            }
            
            .chart-container {
                height: 350px;
            }
            
            .chart-controls {
                overflow-x: auto;
                padding-bottom: 10px;
            }
            
            .tick-indicator {
                width: 48px;
                height: 48px;
                font-size: 24px;
            }
            
            .candle-countdown {
                top: 5px;
                left: 5px;
                padding: 6px 8px;
            }
            
            .candle-countdown-value {
                font-size: 16px;
            }
        }
    </style>
</head>
<body>
    <!-- Theme Toggle Button -->
    <div class="theme-toggle">
        <button class="theme-btn" id="themeToggle">
            üåô
        </button>
    </div>

    <div class="container">
        <div class="header">
            <h1>Advanced Tradingview Chart</h1>
            <p>Real-time chart analysis</p>
            <div class="status-bar">
                <div class="status">
                    <span class="status-dot" id="wsStatus">‚óè</span>
                    <span>Live: <span id="connectionStatus">Connecting...</span></span>
                </div>
                <div class="status">
                    <span>Symbol: <span id="currentSymbol">1HZ10V</span></span>
                </div>
                <div class="status">
                    <span>Timeframe: <span id="currentTimeframe">1D</span></span>
                </div>
            </div>
        </div>

        <div class="dashboard">
            <div class="main-area">
                <div class="chart-area">
                    <!-- Controls Row -->
                    <div class="controls-row">
                        <!-- Left: Timeframes -->
                        <div class="left-controls">
                            <div class="flex items-center gap-1">
                                <button class="timeframe-btn active" onclick="setTimeframe('1')" id="tf1s">1s</button>
                                <button class="timeframe-btn" onclick="setTimeframe('60')" id="tf1m">1m</button>
                                <button class="timeframe-btn" onclick="setTimeframe('300')" id="tf5m">5m</button>
                                <button class="timeframe-btn" onclick="setTimeframe('900')" id="tf15m">15m</button>
                                <button class="timeframe-btn" onclick="setTimeframe('3600')" id="tf1h">1H</button>
                                <button class="timeframe-btn" onclick="setTimeframe('1D')" id="tf1d">1D</button>
                            </div>
                        </div>

                        <!-- Right: Tick Detector -->
                        <div class="right-controls">
                            <!-- Tick Detector -->
                            <div class="tick-detector">
                                <div class="tick-indicator tick-neutral-indicator" id="tickIndicator">
                                    -
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Chart Header -->
                    <div class="chart-header">
                        <div class="symbol-info">
                            <!-- Symbol Dropdown -->
                            <div class="select-wrapper" style="width: 280px;">
                                <select id="symbolSelect" onchange="changeSymbol(this.value)">
                                    <option value="1HZ10V">Volatility 10 (1s) Index</option>
                                    <option value="R_10">Volatility 10 Index</option>
                                    <option value="1HZ15V">Volatility 15 (1s) Index</option>
                                    <option value="1HZ25V">Volatility 25 (1s) Index</option>
                                    <option value="R_25">Volatility 25 Index</option>
                                    <option value="1HZ30V">Volatility 30 (1s) Index</option>
                                    <option value="1HZ50V">Volatility 50 (1s) Index</option>
                                    <option value="R_50">Volatility 50 Index</option>
                                    <option value="1HZ75V">Volatility 75 (1s) Index</option>
                                    <option value="R_75">Volatility 75 Index</option>
                                    <option value="1HZ90V">Volatility 90 (1s) Index</option>
                                    <option value="1HZ100V">Volatility 100 (1s) Index</option>
                                    <option value="R_100">Volatility 100 Index</option>
                                </select>
                            </div>
                            <span id="symbolTypeBadge" class="badge badge-fast">1s</span>
                            <div class="price-display price-up" id="currentPrice">--.--</div>
                            <div class="price-change" id="priceChange">+0.00 (0.00%)</div>
                        </div>
                    </div>

                    <!-- Chart Container -->
                    <div class="chart-container">
                        <!-- TradingView Widget -->
                        <div id="tradingview_chart"></div>
                    </div>

                    <!-- Tick History Panel -->
                    <div class="tick-history">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h3 style="font-size: 14px; margin: 0;">Tick History (Last 20 Ticks)</h3>
                            <div class="tick-stats">
                                <div class="tick-count rise">R: <span id="riseCount">0</span></div>
                                <div class="tick-count fall">F: <span id="fallCount">0</span></div>
                            </div>
                        </div>
                        <div class="tick-pattern" id="tickPattern">
                            <!-- Generated by JavaScript -->
                        </div>
                        <div style="margin-top: 10px; font-size: 12px; color: var(--muted-foreground);">
                            R = Rise, F = Fall
                        </div>
                    </div>

                    <div class="instructions" id="instructions">
                        TradingView Chart with real-time data from Deriv
                    </div>
                </div>
            </div>

            <div class="sidebar">
                <!-- Symbol Selector Panel -->
                <div class="panel">
                    <h3>Select Symbol</h3>
                    <div class="symbol-list">
                        <div class="select-wrapper">
                            <select id="sidebarSymbolSelect" onchange="changeSymbol(this.value)">
                                <option value="1HZ10V">Volatility 10 (1s) Index</option>
                                <option value="R_10">Volatility 10 Index</option>
                                <option value="1HZ15V">Volatility 15 (1s) Index</option>
                                <option value="1HZ25V">Volatility 25 (1s) Index</option>
                                <option value="R_25">Volatility 25 Index</option>
                                <option value="1HZ30V">Volatility 30 (1s) Index</option>
                                <option value="1HZ50V">Volatility 50 (1s) Index</option>
                                <option value="R_50">Volatility 50 Index</option>
                                <option value="1HZ75V">Volatility 75 (1s) Index</option>
                                <option value="R_75">Volatility 75 Index</option>
                                <option value="1HZ90V">Volatility 90 (1s) Index</option>
                                <option value="1HZ100V">Volatility 100 (1s) Index</option>
                                <option value="R_100">Volatility 100 Index</option>
                            </select>
                        </div>
                        <div style="margin-top: 10px; display: flex; align-items: center; gap: 8px;">
                            <span id="selectedSymbolName" style="font-size: 12px; color: var(--muted-foreground);">Volatility 10 (1s) Index</span>
                            <span id="symbolTypeBadge2" class="badge badge-fast">1s</span>
                        </div>
                    </div>
                </div>

                <!-- Connection Status -->
                <div class="panel">
                    <h3>Connection Status</h3>
                    <div style="margin-top: 10px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 12px;">
                            <span>status:</span>
                            <span id="connectionStatusText" style="color: #10b981; font-weight: 500;">Connected</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 12px;">
                            <span>Last Update:</span>
                            <span id="lastUpdate">--:--:--</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 12px;">
                            <span>Subscribed:</span>
                            <span id="subscribedSymbols">1HZ10V</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; font-size: 12px;">
                            <span>Ticks Received:</span>
                            <span id="ticksReceived">0</span>
                        </div>
                    </div>
                </div>

                <!-- Market Data -->
                <div class="panel">
                    <h3>Market Data</h3>
                    <div style="margin-top: 10px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 12px;">
                            <span>Current Price:</span>
                            <span id="marketCurrentPrice">--.--</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 12px;">
                            <span>24h High:</span>
                            <span id="marketHigh">--.--</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; font-size: 12px;">
                            <span>24h Low:</span>
                            <span id="marketLow">--.--</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ======================
        // CONFIGURATION
        // ======================
        const DERIV_WS_URL = 'wss://ws.binaryws.com/websockets/v3?app_id=1089';
        let socket = null;
        let isConnected = false;
        let activeSymbol = '1HZ10V';
        let activeTimeframe = '1';
        
        const SYNTHETIC_INDICES = {
            '1HZ10V': { name: 'Volatility 10 (1s) Index', type: '1s', supportsCandles: false, basePrice: 35000 },
            'R_10': { name: 'Volatility 10 Index', type: 'standard', supportsCandles: true, basePrice: 35000 },
            '1HZ15V': { name: 'Volatility 15 (1s) Index', type: '1s', supportsCandles: false, basePrice: 35000 },
            '1HZ25V': { name: 'Volatility 25 (1s) Index', type: '1s', supportsCandles: false, basePrice: 35000 },
            'R_25': { name: 'Volatility 25 Index', type: 'standard', supportsCandles: true, basePrice: 35000 },
            '1HZ30V': { name: 'Volatility 30 (1s) Index', type: '1s', supportsCandles: false, basePrice: 35000 },
            '1HZ50V': { name: 'Volatility 50 (1s) Index', type: '1s', supportsCandles: false, basePrice: 35000 },
            'R_50': { name: 'Volatility 50 Index', type: 'standard', supportsCandles: true, basePrice: 35000 },
            '1HZ75V': { name: 'Volatility 75 (1s) Index', type: '1s', supportsCandles: false, basePrice: 35000 },
            'R_75': { name: 'Volatility 75 Index', type: 'standard', supportsCandles: true, basePrice: 35000 },
            '1HZ90V': { name: 'Volatility 90 (1s) Index', type: '1s', supportsCandles: false, basePrice: 35000 },
            '1HZ100V': { name: 'Volatility 100 (1s) Index', type: '1s', supportsCandles: false, basePrice: 35000 },
            'R_100': { name: 'Volatility 100 Index', type: 'standard', supportsCandles: true, basePrice: 35000 }
        };

        // ======================
        // TRADINGVIEW WIDGET
        // ======================
        let tradingViewWidget = null;
        let ticks = [];
        let currentPrice = 0;
        let previousPrice = 0;

        // Subscription tracking
        let currentTickSubscription = null;
        let currentCandleSubscription = null;

        // ======================
        // THEME MANAGEMENT
        // ======================
        function initTheme() {
            const themeToggle = document.getElementById('themeToggle');
            const savedTheme = localStorage.getItem('theme') || 'dark';
            
            if (savedTheme === 'light') {
                document.body.classList.add('light-mode');
                themeToggle.textContent = 'üåô';
            } else {
                document.body.classList.remove('light-mode');
                themeToggle.textContent = '‚òÄÔ∏è';
            }
            
            themeToggle.addEventListener('click', () => {
                if (document.body.classList.contains('light-mode')) {
                    document.body.classList.remove('light-mode');
                    localStorage.setItem('theme', 'dark');
                    themeToggle.textContent = '‚òÄÔ∏è';
                } else {
                    document.body.classList.add('light-mode');
                    localStorage.setItem('theme', 'light');
                    themeToggle.textContent = 'üåô';
                }
                updateTradingViewTheme();
            });
        }

        function updateTradingViewTheme() {
            if (tradingViewWidget) {
                const theme = document.body.classList.contains('light-mode') ? 'light' : 'dark';
                tradingViewWidget.changeTheme(theme, {});
            }
        }

        // ======================
        // INITIALIZATION
        // ======================
        function init() {
            initTheme();
            initTradingViewWidget();
            connectToDeriv();
            
            updateSymbolUI();
            updateLastUpdate();
        }

        function initTradingViewWidget() {
            const widgetOptions = {
                symbol: activeSymbol,
                interval: activeTimeframe,
                container: "tradingview_chart",
                datafeed: new Datafeed(),
                library_path: "https://charting-library.tradingview.com/",
                locale: "en",
                disabled_features: ["header_symbol_search", "symbol_search_hot_key", "header_compare", "header_settings", "use_localstorage_for_settings"],
                enabled_features: ["study_templates"],
                theme: document.body.classList.contains('light-mode') ? 'light' : 'dark',
                autosize: true,
                toolbar_bg: document.body.classList.contains('light-mode') ? '#f1f5f9' : '#1e293b',
                overrides: {
                    "paneProperties.background": document.body.classList.contains('light-mode') ? '#f1f5f9' : '#1e293b',
                    "paneProperties.vertGridProperties.color": document.body.classList.contains('light-mode') ? '#e2e8f0' : 'rgba(255, 255, 255, 0.1)',
                    "paneProperties.horzGridProperties.color": document.body.classList.contains('light-mode') ? '#e2e8f0' : 'rgba(255, 255, 255, 0.1)',
                    "scalesProperties.textColor": document.body.classList.contains('light-mode') ? '#64748b' : '#9ca3af',
                },
                loading_screen: { backgroundColor: document.body.classList.contains('light-mode') ? '#f1f5f9' : '#1e293b' },
                fullscreen: false,
                autosize: true,
                studies_overrides: {},
            };

            tradingViewWidget = new TradingView.widget(widgetOptions);

            tradingViewWidget.onChartReady(() => {
                console.log('TradingView chart is ready');
                updateConnectionStatus('Connected', '#10b981');
            });
        }

        // ======================
        // DATAFEED IMPLEMENTATION
        // ======================
        class Datafeed {
            constructor() {
                this._configuration = {
                    supports_time: true,
                    supports_marks: false,
                    supports_timescale_marks: false,
                    supports_search: true,
                    supports_group_request: false,
                    supported_resolutions: ["1", "5", "15", "30", "60", "240", "D", "W", "M"]
                };
            }

            onReady(callback) {
                setTimeout(() => callback(this._configuration));
            }

            resolveSymbol(symbolName, onSymbolResolvedCallback, onResolveErrorCallback) {
                const symbolInfo = {
                    name: symbolName,
                    full_name: symbolName,
                    description: SYNTHETIC_INDICES[symbolName]?.name || symbolName,
                    type: 'index',
                    session: '24x7',
                    timezone: 'Etc/UTC',
                    ticker: symbolName,
                    minmov: 1,
                    minmove2: 0,
                    pricescale: 100,
                    has_intraday: true,
                    intraday_multipliers: ['1', '5', '15', '30', '60', '240'],
                    supported_resolutions: this._configuration.supported_resolutions,
                    volume_precision: 0,
                    data_status: 'streaming'
                };
                
                onSymbolResolvedCallback(symbolInfo);
            }

            getBars(symbolInfo, resolution, from, to, onHistoryCallback, onErrorCallback, firstDataRequest) {
                // We'll use the Deriv WebSocket to get historical data
                if (isConnected && socket && socket.readyState === WebSocket.OPEN) {
                    const granularity = this._convertResolutionToSeconds(resolution);
                    
                    const candlesMsg = {
                        ticks_history: symbolInfo.ticker,
                        style: 'candles',
                        granularity: granularity,
                        count: 200,
                        end: 'latest',
                        subscribe: 1
                    };
                    
                    socket.send(JSON.stringify(candlesMsg));
                    
                    // Store callback for when data arrives
                    this._historyCallback = onHistoryCallback;
                } else {
                    onErrorCallback('Not connected to Deriv');
                }
            }

            subscribeBars(symbolInfo, resolution, onRealtimeCallback, subscribeUID, onResetCacheNeededCallback) {
                this._realtimeCallback = onRealtimeCallback;
                this._subscribeUID = subscribeUID;
            }

            unsubscribeBars(subscribeUID) {
                this._realtimeCallback = null;
                this._subscribeUID = null;
            }

            _convertResolutionToSeconds(resolution) {
                switch(resolution) {
                    case '1': return 1;
                    case '5': return 5;
                    case '15': return 15;
                    case '30': return 30;
                    case '60': return 60;
                    case '240': return 240;
                    case 'D': return 86400;
                    default: return 60;
                }
            }

            handleCandleData(candlesData) {
                if (!candlesData || !candlesData.length) return;
                
                const bars = candlesData.map(candle => ({
                    time: candle.epoch * 1000,
                    open: parseFloat(candle.open),
                    high: parseFloat(candle.high),
                    low: parseFloat(candle.low),
                    close: parseFloat(candle.close),
                    volume: 0
                })).reverse();
                
                if (this._historyCallback) {
                    this._historyCallback(bars, { noData: false });
                    this._historyCallback = null;
                }
            }

            handleTickData(tick) {
                if (!tick || !tick.quote) return;
                
                previousPrice = currentPrice;
                currentPrice = parseFloat(tick.quote);
                
                // Add to tick history
                ticks.unshift({
                    quote: currentPrice,
                    epoch: tick.epoch,
                    symbol: tick.symbol
                });
                
                if (ticks.length > 100) {
                    ticks.pop();
                }
                
                updatePriceDisplay();
                updateTickHistory();
                updateTickIndicator();
                updateLastUpdate();
                
                document.getElementById('ticksReceived').textContent = ticks.length;
                
                // Update TradingView with tick data
                if (this._realtimeCallback && currentPrice) {
                    const now = Math.floor(Date.now() / 1000);
                    const barTime = Math.floor(now / this._convertResolutionToSeconds(activeTimeframe)) * 
                                   this._convertResolutionToSeconds(activeTimeframe) * 1000;
                    
                    this._realtimeCallback({
                        time: barTime,
                        open: currentPrice,
                        high: currentPrice,
                        low: currentPrice,
                        close: currentPrice,
                        volume: 0
                    });
                }
            }
        }

        // ======================
        // WEBSOCKET CONNECTION
        // ======================
        function connectToDeriv() {
            try {
                socket = new WebSocket(DERIV_WS_URL);
                
                socket.onopen = function() {
                    console.log('‚úÖ Connected to Deriv WebSocket');
                    isConnected = true;
                    updateConnectionStatus('Connected', '#10b981');
                    
                    subscribeToSymbol(activeSymbol);
                };
                
                socket.onmessage = function(event) {
                    const data = JSON.parse(event.data);
                    handleDerivMessage(data);
                };
                
                socket.onerror = function(error) {
                    console.error('WebSocket Error:', error);
                    updateConnectionStatus('Error', '#ef4444');
                    isConnected = false;
                };
                
                socket.onclose = function() {
                    console.log('WebSocket Disconnected');
                    updateConnectionStatus('Disconnected', '#ef4444');
                    isConnected = false;
                    currentTickSubscription = null;
                    currentCandleSubscription = null;
                    
                    setTimeout(connectToDeriv, 5000);
                };
            } catch (error) {
                console.error('Failed to connect:', error);
                updateConnectionStatus('Failed', '#ef4444');
            }
        }

        function unsubscribeFromTicks() {
            if (currentTickSubscription && socket && socket.readyState === WebSocket.OPEN) {
                const unsubscribeMsg = { ticks: currentTickSubscription, subscribe: 0 };
                socket.send(JSON.stringify(unsubscribeMsg));
                console.log(`Unsubscribed from ticks for ${currentTickSubscription}`);
                currentTickSubscription = null;
            }
        }

        function subscribeToSymbol(symbol) {
            if (!socket || socket.readyState !== WebSocket.OPEN) return;
            
            // Unsubscribe from previous ticks if different
            if (currentTickSubscription && currentTickSubscription !== symbol) {
                unsubscribeFromTicks();
            }
            
            const subscribeMsg = {
                ticks: symbol,
                subscribe: 1
            };
            
            socket.send(JSON.stringify(subscribeMsg));
            console.log(`üì° Subscribed to ${symbol}`);
            currentTickSubscription = symbol;
            
            document.getElementById('subscribedSymbols').textContent = symbol;
        }

        function handleDerivMessage(data) {
            if (data.msg_type === 'tick') {
                handleTickData(data.tick);
            } else if (data.msg_type === 'candles') {
                // Handle candle data for TradingView
                const datafeed = tradingViewWidget?._options?.datafeed;
                if (datafeed && datafeed.handleCandleData) {
                    datafeed.handleCandleData(data.candles);
                }
            } else if (data.error) {
                console.warn('Deriv API Warning:', data.error?.message || 'API Error');
            }
        }

        function handleTickData(tick) {
            const datafeed = tradingViewWidget?._options?.datafeed;
            if (datafeed && datafeed.handleTickData) {
                datafeed.handleTickData(tick);
            }
        }

        // ======================
        // UI CONTROLS
        // ======================
        function setTimeframe(timeframe) {
            activeTimeframe = timeframe;
            
            // Update button states
            document.querySelectorAll('.timeframe-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById('tf' + timeframe.replace('/', '')).classList.add('active');
            
            document.getElementById('currentTimeframe').textContent = timeframe;
            
            if (tradingViewWidget) {
                tradingViewWidget.setSymbol(activeSymbol, timeframe);
            }
        }

        function changeSymbol(symbol) {
            // Unsubscribe from current tick
            if (isConnected) {
                unsubscribeFromTicks();
            }

            activeSymbol = symbol;
            
            document.getElementById('symbolSelect').value = symbol;
            document.getElementById('sidebarSymbolSelect').value = symbol;
            
            updateSymbolUI();
            
            // Clear tick history
            ticks = [];
            currentPrice = 0;
            previousPrice = 0;
            
            // Request new data
            if (isConnected) {
                subscribeToSymbol(symbol);
            }
            
            // Update TradingView widget
            if (tradingViewWidget) {
                tradingViewWidget.setSymbol(symbol, activeTimeframe);
            }
        }

        // ======================
        // UI UPDATES
        // ======================
        function updateSymbolUI() {
            const symbolInfo = SYNTHETIC_INDICES[activeSymbol];
            if (!symbolInfo) return;
            
            document.getElementById('currentSymbol').textContent = activeSymbol;
            document.getElementById('selectedSymbolName').textContent = symbolInfo.name;
            
            const isFast = symbolInfo.type === '1s';
            const badgeClass = isFast ? 'badge-fast' : 'badge-standard';
            const badgeText = isFast ? '1s' : 'Standard';
            
            document.getElementById('symbolTypeBadge').className = 'badge ' + badgeClass;
            document.getElementById('symbolTypeBadge').textContent = badgeText;
            document.getElementById('symbolTypeBadge2').className = 'badge ' + badgeClass;
            document.getElementById('symbolTypeBadge2').textContent = badgeText;
        }

        function updatePriceDisplay() {
            const priceElement = document.getElementById('currentPrice');
            const changeElement = document.getElementById('priceChange');
            const marketPriceElement = document.getElementById('marketCurrentPrice');
            
            if (currentPrice > 0) {
                priceElement.textContent = currentPrice.toFixed(2);
                marketPriceElement.textContent = currentPrice.toFixed(2);
                
                if (previousPrice > 0) {
                    const change = currentPrice - previousPrice;
                    const changePercent = (change / previousPrice) * 100;
                    
                    const isPositive = change >= 0;
                    const changeText = `${isPositive ? '+' : ''}${change.toFixed(2)} (${isPositive ? '+' : ''}${changePercent.toFixed(2)}%)`;
                    
                    changeElement.textContent = changeText;
                    changeElement.className = isPositive ? 'price-change price-up' : 'price-change price-down';
                    priceElement.className = isPositive ? 'price-display price-up' : 'price-display price-down';
                }
            }
        }

        function updateTickHistory() {
            const container = document.getElementById('tickPattern');
            if (ticks.length < 2) {
                container.innerHTML = '<span style="color: var(--muted-foreground); font-size: 12px;">Waiting for ticks...</span>';
                return;
            }
            
            let html = '';
            let riseCount = 0;
            let fallCount = 0;
            
            const maxHistory = 20;
            const startIndex = Math.max(0, Math.min(ticks.length - 1, maxHistory));
            
            for (let i = startIndex; i > 0; i--) {
                const current = ticks[i];
                const previous = ticks[i - 1];
                
                if (current.quote > previous.quote) {
                    html = `<div class="tick-rise">R</div>` + html;
                    riseCount++;
                } else if (current.quote < previous.quote) {
                    html = `<div class="tick-fall">F</div>` + html;
                    fallCount++;
                } else {
                    html = `<div class="tick-neutral">-</div>` + html;
                }
            }
            
            container.innerHTML = html;
            
            document.getElementById('riseCount').textContent = riseCount;
            document.getElementById('fallCount').textContent = fallCount;
        }

        function updateTickIndicator() {
            const indicator = document.getElementById('tickIndicator');
            
            if (currentPrice > previousPrice) {
                indicator.className = 'tick-indicator tick-rise-indicator tick-flash';
                indicator.textContent = 'R';
            } else if (currentPrice < previousPrice) {
                indicator.className = 'tick-indicator tick-fall-indicator tick-flash';
                indicator.textContent = 'F';
            } else {
                indicator.className = 'tick-indicator tick-neutral-indicator';
                indicator.textContent = '-';
            }
            
            setTimeout(() => {
                indicator.classList.remove('tick-flash');
            }, 300);
        }

        function updateConnectionStatus(status, color) {
            const statusElement = document.getElementById('connectionStatus');
            const statusDot = document.getElementById('wsStatus');
            const statusText = document.getElementById('connectionStatusText');
            
            statusElement.textContent = status;
            statusText.textContent = status;
            statusText.style.color = color;
            statusDot.style.color = color;
            statusDot.className = status === 'Connected' ? 'status-dot connected' : 'status-dot disconnected';
        }

        function updateLastUpdate() {
            const now = new Date();
            document.getElementById('lastUpdate').textContent = 
                now.getHours().toString().padStart(2, '0') + ':' + 
                now.getMinutes().toString().padStart(2, '0') + ':' + 
                now.getSeconds().toString().padStart(2, '0');
        }

        // ======================
        // INITIALIZE
        // ======================
        window.addEventListener('load', init);
    </script>
</body>
</html>
